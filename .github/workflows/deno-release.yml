name: "📦 Deno Package Release"

# Builds Linux x86_64 + Windows x86_64 binaries and creates draft GitHub Release
# Does NOT publish release - remains as draft
# Does NOT create tags - only responds to existing tags

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+' # Semantic versions only
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag version (e.g., v1.0.0)'
        required: true
        type: string

concurrency:
  group: release-${{ github.ref }}-${{ github.event.inputs.tag || '' }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: read

env:
  DENO_VERSION: '2.4'

jobs:
  # Phase 1: Stability Check
  stability-check:
    name: "🔍 Stability Validation"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      is_stable: ${{ steps.stability_validation.outputs.is_stable }}
      version: ${{ steps.stability_validation.outputs.version }}
      tag: ${{ steps.stability_validation.outputs.tag }}
      
    steps:
      - name: "🏷️ Extract Version"
        id: extract_version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
            VERSION="${TAG#v}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#v}"
          fi
          
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "📌 Processing tag: $TAG (version: $VERSION)"

      - name: "🔎 Validate Stability Rules"
        id: stability_validation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.extract_version.outputs.VERSION }}"
          TAG="${{ steps.extract_version.outputs.TAG }}"
          
          echo "🔍 Validating stability for version: $VERSION"
          
          # Check version format
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid version format: $VERSION (must be semantic: x.y.z)"
            echo "is_stable=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Parse version components
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)
          
          echo "📊 Version components: $MAJOR.$MINOR.$PATCH"
          
          if [[ "$MAJOR" == "0" ]]; then
            # Development phase checks
            VERSION_NUM=$(echo "$VERSION" | awk -F. '{printf "%d%02d%02d\n", $1, $2, $3}')
            MILESTONE_NUM=100  # 0.1.0
            
            if [[ "$VERSION_NUM" -lt "$MILESTONE_NUM" ]]; then
              echo "🔍 Development phase (before v0.1.0) - checking for active fix PRs..."
              
              ACTIVE_FIX_PRS=$(gh pr list \
                --repo "${{ github.repository }}" \
                --state open \
                --json number,title,labels \
                --jq '.[] | select(
                  (.title | test("^(fix|bugfix|hotfix)"; "i")) or
                  (.labels[]?.name | test("(fix|bug|hotfix)"; "i"))
                ) | .number' | wc -l)
              
              echo "📊 Active fix PRs found: $ACTIVE_FIX_PRS"
              
              if [[ "$ACTIVE_FIX_PRS" -gt 0 ]]; then
                echo "❌ STABILITY CHECK FAILED"
                echo "   Development phase requires no active fix PRs"
                echo "   Found $ACTIVE_FIX_PRS active fix PR(s)"
                
                # List problematic PRs
                echo "🔍 Active fix PRs:"
                gh pr list \
                  --repo "${{ github.repository }}" \
                  --state open \
                  --json number,title \
                  --jq '.[] | select(.title | test("^(fix|bugfix|hotfix)"; "i")) | "  #\(.number): \(.title)"'
                
                echo "is_stable=false" >> $GITHUB_OUTPUT
                exit 1
              else
                echo "✅ STABILITY CHECK PASSED - No active fix PRs"
                echo "is_stable=true" >> $GITHUB_OUTPUT
              fi
            else
              echo "🚀 Pre-production milestone (v0.1.0+)"
              echo "is_stable=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "🎉 Production version (v1.0.0+)"
            echo "is_stable=true" >> $GITHUB_OUTPUT
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

  # Phase 2: Build Matrix - Multi-platform binaries
  build-binaries:
    name: "🔨 Build ${{ matrix.platform.name }}"
    runs-on: ${{ matrix.platform.os }}
    needs: stability-check
    if: needs.stability-check.outputs.is_stable == 'true'
    permissions:
      contents: read
    
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: "Linux x86_64"
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            output: mikrus-linux-x64
            artifact: linux-x64
          - name: "Windows x86_64"
            os: windows-latest
            target: x86_64-pc-windows-msvc
            output: mikrus-windows-x64.exe
            artifact: windows-x64
    
    outputs:
      binary_size_linux: ${{ steps.analysis.outputs.BINARY_SIZE_MB }}
      binary_size_windows: ${{ steps.analysis.outputs.BINARY_SIZE_MB }}
    
    steps:
      - name: "📥 Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "🦕 Setup Deno"
        uses: denoland/setup-deno@v2
        with:
          deno-version: ${{ env.DENO_VERSION }}
          cache-hash: ${{ hashFiles('**/deno.json', '**/deno.lock') }}

      - name: "📦 Cache Dependencies"
        run: |
          echo "📦 Caching Deno dependencies..."
          deno cache src/cli.ts

      - name: "🔨 Compile ${{ matrix.platform.name }} Binary"
        run: |
          echo "🔨 Compiling ${{ matrix.platform.name }} binary..."

          VERSION="${{ needs.stability-check.outputs.version }}"
          GIT_HASH="${GITHUB_SHA::7}"
          
          # Cross-platform version replacement
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            # Windows using PowerShell
            powershell -Command "(Get-Content ./src/version.ts) -replace '%VERSION%', '$VERSION' | Set-Content ./src/version.ts"
            powershell -Command "(Get-Content ./src/version.ts) -replace '%GIT_HASH%', '$GIT_HASH' | Set-Content ./src/version.ts"
          else
            # Unix (Linux/macOS)
            sed -i "s/%VERSION%/$VERSION/g" ./src/version.ts
            sed -i "s/%GIT_HASH%/$GIT_HASH/g" ./src/version.ts
          fi

          # Create dist directory
          mkdir -p ./dist
          
          # Compile with Deno for target platform
          deno compile \
            --allow-read \
            --allow-write \
            --allow-net \
            --target=${{ matrix.platform.target }} \
            --output=./dist/${{ matrix.platform.output }} \
            src/cli.ts
          
          echo "✅ Binary compiled successfully for ${{ matrix.platform.name }}"

      - name: "🧪 Test Binary"
        run: |
          echo "🧪 Testing compiled binary..."
          
          # Make executable on Unix systems
          if [[ "${{ runner.os }}" != "Windows" ]]; then
            chmod +x ./dist/${{ matrix.platform.output }}
          fi
          
          # Test basic functionality
          ./dist/${{ matrix.platform.output }} --version
          ./dist/${{ matrix.platform.output }} --help
          
          echo "✅ Binary tests passed for ${{ matrix.platform.name }}"

      - name: "📊 Binary Analysis"
        id: analysis
        run: |
          echo "📊 Analyzing binary..."
          
          # Cross-platform file size calculation
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            SIZE=$(stat -c%s "./dist/${{ matrix.platform.output }}" 2>/dev/null || echo "0")
          else
            SIZE=$(stat -c%s "./dist/${{ matrix.platform.output }}" 2>/dev/null || stat -f%z "./dist/${{ matrix.platform.output }}" 2>/dev/null || echo "0")
          fi
          
          SIZE_MB=$((SIZE / 1024 / 1024))
          
          echo "BINARY_SIZE_MB=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "📦 Binary size: ${SIZE_MB}MB"
          
          # Cross-platform checksum creation
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            certutil -hashfile "./dist/${{ matrix.platform.output }}" SHA256 > "./dist/${{ matrix.platform.output }}.sha256"
          else
            sha256sum "./dist/${{ matrix.platform.output }}" > "./dist/${{ matrix.platform.output }}.sha256"
          fi
          
          echo "🔒 Checksum created for ${{ matrix.platform.name }}"

      - name: "📤 Upload Binary Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform.artifact }}
          path: |
            ./dist/${{ matrix.platform.output }}
            ./dist/${{ matrix.platform.output }}.sha256
          retention-days: 7
          compression-level: 9

      - name: "📊 Build Summary"
        run: |
          echo "## 🔨 ${{ matrix.platform.name }} Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ matrix.platform.target }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Binary**: ${{ matrix.platform.output }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: ${{ steps.analysis.outputs.BINARY_SIZE_MB }}MB" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.stability-check.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ✅ Success" >> $GITHUB_STEP_SUMMARY

  # Phase 3: Create Draft Release
  create-draft-release:
    name: "📝 Create Draft Release"
    runs-on: ubuntu-latest
    needs: [stability-check, build-binaries]
    permissions:
      contents: write
    
    steps:
      - name: "📥 Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "📥 Download All Binaries"
        uses: actions/download-artifact@v4
        with:
          path: ./release-assets

      - name: "📝 Generate Release Notes"
        id: release_notes
        env:
          VERSION: ${{ needs.stability-check.outputs.version }}
          TAG: ${{ needs.stability-check.outputs.tag }}
        run: |
          # Get binary sizes
          LINUX_SIZE=$(find ./release-assets -name "mikrus-linux-x64" -exec stat -c%s {} \; | awk '{print int($1/1024/1024)"MB"}' 2>/dev/null || echo "~MB")
          WINDOWS_SIZE=$(find ./release-assets -name "mikrus-windows-x64.exe" -exec stat -c%s {} \; | awk '{print int($1/1024/1024)"MB"}' 2>/dev/null || echo "~MB")
          
          cat > release_notes.md << EOF
          ## 🚀 mikrus CLI ${{ env.TAG }}
          
          ### 📦 Assets
          
          | Platform | Architecture | Size | File |
          |----------|-------------|------|------|
          | Linux | x86_64 | ${LINUX_SIZE} | \`mikrus-linux-x64\` |
          | Windows | x86_64 | ${WINDOWS_SIZE} | \`mikrus-windows-x64.exe\` |
          
          ### 🔧 Installation
          
          #### Linux x86_64
          \`\`\`bash
          # Download binary
          wget https://github.com/${{ github.repository }}/releases/download/${{ env.TAG }}/mikrus-linux-x64
          
          # Make executable
          chmod +x mikrus-linux-x64
          
          # Move to PATH (optional)
          sudo mv mikrus-linux-x64 /usr/local/bin/mikrus
          
          # Verify installation
          mikrus --version
          \`\`\`
          
          #### Windows x86_64
          \`\`\`powershell
          # Download binary (PowerShell)
          Invoke-WebRequest -Uri "https://github.com/${{ github.repository }}/releases/download/${{ env.TAG }}/mikrus-windows-x64.exe" -OutFile "mikrus.exe"
          
          # Or using curl (if available)
          curl -L -o mikrus.exe "https://github.com/${{ github.repository }}/releases/download/${{ env.TAG }}/mikrus-windows-x64.exe"
          
          # Verify installation
          .\mikrus.exe --version
          \`\`\`
          
          ### 🔐 Verify Integrity
          
          #### Linux
          \`\`\`bash
          # Download checksum file
          wget https://github.com/${{ github.repository }}/releases/download/${{ env.TAG }}/mikrus-linux-x64.sha256
          
          # Verify checksum
          sha256sum -c mikrus-linux-x64.sha256
          \`\`\`
          
          #### Windows
          \`\`\`powershell
          # Download checksum file
          Invoke-WebRequest -Uri "https://github.com/${{ github.repository }}/releases/download/${{ env.TAG }}/mikrus-windows-x64.exe.sha256" -OutFile "mikrus-windows-x64.exe.sha256"
          
          # Verify checksum (PowerShell)
          \$hash = Get-FileHash -Path "mikrus.exe" -Algorithm SHA256
          \$expected = Get-Content "mikrus-windows-x64.exe.sha256"
          if (\$hash.Hash -eq \$expected.Split()[0]) { Write-Host "✅ Checksum verified" } else { Write-Host "❌ Checksum mismatch" }
          \`\`\`
          
          ### 📝 Changelog
          
          <!-- Changelog will be auto-generated from commits -->
          
          ### 🔧 Usage
          
          ```bash
          # Show help
          mikrus --help
          
          # Generate model files
          mikrus generate <name>
          
          # Check version
          mikrus --version
          ```
          
          ### 📋 Requirements
          
          **Linux x86_64:**
          - Linux x86_64 (64-bit)
          - No external dependencies (Deno runtime embedded)
          
          **Windows x86_64:**
          - Windows 10/11 x86_64 (64-bit)
          - No external dependencies (Deno runtime embedded)
          
          ### 📚 Documentation
          
          - [README](https://github.com/${{ github.repository }}#readme)
          - [Issues & Support](https://github.com/${{ github.repository }}/issues)
          
          ---
          
          **⚠️ Note:** This is a draft release. Review and publish when ready.
          EOF
          
          echo "✅ Release notes generated"

      - name: "🏷️ Create Draft Release"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.stability-check.outputs.tag }}
        run: |
          echo "📝 Creating draft release for $TAG..."
          
          # Check if release already exists
          EXISTING_RELEASE=$(gh release view "$TAG" --json id 2>/dev/null || echo "")
          
          if [[ -n "$EXISTING_RELEASE" ]]; then
            echo "⚠️  Release $TAG already exists. Deleting old draft..."
            gh release delete "$TAG" --yes --cleanup-tag 2>/dev/null || true
          fi
          
          # Create new draft release with all assets
          gh release create "$TAG" \
            --draft \
            --title "mikrus CLI $TAG" \
            --notes-file release_notes.md \
            ./release-assets/linux-x64/mikrus-linux-x64 \
            ./release-assets/linux-x64/mikrus-linux-x64.sha256 \
            ./release-assets/windows-x64/mikrus-windows-x64.exe \
            ./release-assets/windows-x64/mikrus-windows-x64.exe.sha256
          
          echo "✅ Draft release created successfully"
          echo "📌 Release URL: https://github.com/${{ github.repository }}/releases/tag/$TAG"

      - name: "📊 Release Summary"
        env:
          TAG: ${{ needs.stability-check.outputs.tag }}
        run: |
          echo "## 📝 Draft Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📌 Release Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: $TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Draft (not published)" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms**: Linux x86_64 + Windows x86_64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📦 Included Assets" >> $GITHUB_STEP_SUMMARY
          echo "**Linux x86_64:**" >> $GITHUB_STEP_SUMMARY
          echo "- mikrus-linux-x64 (Linux binary)" >> $GITHUB_STEP_SUMMARY
          echo "- mikrus-linux-x64.sha256 (SHA256 checksum)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Windows x86_64:**" >> $GITHUB_STEP_SUMMARY
          echo "- mikrus-windows-x64.exe (Windows binary)" >> $GITHUB_STEP_SUMMARY
          echo "- mikrus-windows-x64.exe.sha256 (SHA256 checksum)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ⚠️ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the draft release at [GitHub Releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
          echo "2. Edit release notes if needed" >> $GITHUB_STEP_SUMMARY
          echo "3. Publish when ready" >> $GITHUB_STEP_SUMMARY
