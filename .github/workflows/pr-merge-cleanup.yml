name: Repository Maintenance (PR Cleanup)

# Automatic repository cleanup after pull request merges
# Triggers: PR closed (merged)
# Purpose: Removes merged feature branches and provides cleanup summary

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  cleanup-merged-branch:
    name: "🧹 Cleanup: Delete Merged Feature Branch"
    # Automatically removes merged feature branches (protects main/master/develop)
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: "🗋 Branch Removal: Safe Deletion Logic"
        # Deletes merged branch with protection for main/master/develop branches
        run: |
          echo "🧹 Auto-deleting merged branch: ${{ github.event.pull_request.head.ref }}"
          
          # Only delete if it's not a protected branch
          if [[ "${{ github.event.pull_request.head.ref }}" != "main" && "${{ github.event.pull_request.head.ref }}" != "master" && "${{ github.event.pull_request.head.ref }}" != "develop" ]]; then
            gh api repos/${{ github.repository }}/git/refs/heads/${{ github.event.pull_request.head.ref }} --method DELETE || echo "⚠️ Branch may already be deleted"
            echo "✅ Branch ${{ github.event.pull_request.head.ref }} deleted successfully"
          else
            echo "🔒 Protected branch - not deleting ${{ github.event.pull_request.head.ref }}"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup-summary:
    name: "📊 Summary: Cleanup Results Report"
    # Provides detailed summary of cleanup operations and their outcomes
    runs-on: ubuntu-latest
    needs: [cleanup-merged-branch]
    if: always() && github.event.pull_request.merged == true
    steps:
      - name: "📝 Report: Generate Cleanup Summary"
        # Creates comprehensive report of cleanup operations and results
        run: |
          echo "📋 PR Merge Cleanup Summary:"
          echo "• PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          echo "• Branch: ${{ github.event.pull_request.head.ref }}"
          echo "• Status: ${{ needs.cleanup-merged-branch.result }}"
          
          if [[ "${{ needs.cleanup-merged-branch.result }}" == "success" ]]; then
            echo "✅ Cleanup completed successfully"
          elif [[ "${{ needs.cleanup-merged-branch.result }}" == "skipped" ]]; then
            echo "ℹ️ Cleanup skipped (protected branch or different repository)"
          else
            echo "⚠️ Cleanup encountered issues - check logs"
          fi